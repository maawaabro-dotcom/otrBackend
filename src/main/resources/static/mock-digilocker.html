<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigiLocker - Document Verification</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; padding: 20px; }
        .container { background: white; border-radius: 15px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); width: 100%; max-width: 500px; overflow: hidden; }
        .header { background: #1a237e; color: white; padding: 25px; text-align: center; }
        .header h1 { font-size: 24px; margin-bottom: 5px; }
        .header p { opacity: 0.8; font-size: 14px; }
        .content { padding: 30px; }
        .user-info { background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px; border-left: 4px solid #1a237e; }
        .user-info h3 { color: #1a237e; margin-bottom: 15px; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid #e9ecef; }
        .info-label { font-weight: 600; color: #495057; }
        .info-value { color: #6c757d; }
        .documents-section { margin-bottom: 25px; }
        .documents-section h3 { color: #1a237e; margin-bottom: 15px; }
        .document-item { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e9ecef; cursor: pointer; transition: all 0.3s ease; }
        .document-item:hover { background: #e3f2fd; border-color: #1a237e; }
        .document-item.selected { background: #e8f5e8; border-color: #4caf50; }
        .document-name { font-weight: 600; color: #1a237e; margin-bottom: 5px; }
        .document-status { font-size: 12px; color: #6c757d; }
        .document-status.available { color: #4caf50; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-bottom: 10px; }
        .btn-primary { background: #1a237e; color: white; }
        .btn-primary:hover { background: #303f9f; transform: translateY(-2px); }
        .btn-success { background: #4caf50; color: white; }
        .btn-success:hover { background: #45a049; transform: translateY(-2px); }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #1a237e; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .success-message { display: none; background: #d4edda; color: #155724; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; border: 1px solid #c3e6cb; }
        .error-message { display: none; background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; border: 1px solid #f5c6cb; }
        .footer { text-align: center; padding: 20px; background: #f8f9fa; color: #6c757d; font-size: 12px; }
        .progress-bar { width: 100%; height: 6px; background: #e9ecef; border-radius: 3px; margin: 15px 0; overflow: hidden; }
        .progress-fill { height: 100%; background: #1a237e; width: 0%; transition: width 0.3s ease; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>DigiLocker</h1>
            <p>Digital Locker for Indian Citizens</p>
        </div>
 
        <div class="content">
            <div class="error-message" id="errorMessage">
                <h3>‚ö†Ô∏è Data Loading Failed</h3>
                <p id="errorText">Unable to load candidate information</p>
            </div>
 
            <div class="user-info">
                <h3>User Information</h3>
                <div class="info-row">
                    <span class="info-label">Name:</span>
                    <span class="info-value" id="userName">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Aadhar:</span>
                    <span class="info-value" id="userAadhar">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Date of Birth:</span>
                    <span class="info-value" id="userDOB">Loading...</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Candidate ID:</span>
                    <span class="info-value" id="userCandidateId">Loading...</span>
                </div>
            </div>
 
            <div class="documents-section">
                <h3>Available Documents</h3>
                <div id="documentsList">
                    <div class="document-item" onclick="selectDocument(this, '10th_certificate')">
                        <div class="document-name">10th Class Marksheet</div>
                        <div class="document-status available">Available in DigiLocker</div>
                    </div>
                    <div class="document-item" onclick="selectDocument(this, '12th_certificate')">
                        <div class="document-name">12th Class Marksheet</div>
                        <div class="document-status available">Available in DigiLocker</div>
                    </div>
                    <div class="document-item" onclick="selectDocument(this, 'degree_certificate')">
                        <div class="document-name">Degree Certificate</div>
                        <div class="document-status available">Available in DigiLocker</div>
                    </div>
                    <div class="document-item" onclick="selectDocument(this, 'btech_certificate')">
                        <div class="document-name">B.Tech Degree</div>
                        <div class="document-status available">Available in DigiLocker</div>
                    </div>
                </div>
            </div>
 
            <button class="btn btn-primary" onclick="fetchDocumentsFromDigiLocker()" id="fetchBtn">
                üì• Fetch from DigiLocker
            </button>
 
            <div class="loading" id="loadingSection">
                <div class="spinner"></div>
                <p>Connecting to DigiLocker...</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="loadingStatus">Initializing connection</p>
            </div>
 
            <div class="success-message" id="successMessage">
                <h3>‚úÖ Documents Fetched Successfully!</h3>
                <p>Your documents have been verified and will be sent to the application.</p>
            </div>
 
            <button class="btn btn-success" onclick="submitToApplication()" id="submitBtn" style="display: none;">
                üì§ Submit to Application
            </button>
			            <button class="btn btn-secondary" onclick="closeWindow()">
			                ‚ùå Cancel
			            </button>
			        </div>
			 
			        <div class="footer">
			            <p>Secured by DigiLocker - Government of India</p>
			            <p>¬© 2024 DigiLocker - Ministry of Electronics & IT</p>
			        </div>
			    </div>
			 
			    <script>
			        // Global variables
			        const urlParams = new URLSearchParams(window.location.search);
			        const candidateId = urlParams.get('candidateId');
			        let selectedDocuments = [];
			        let fetchedDocuments = {};
			 
			        // Initialize application
			        document.addEventListener('DOMContentLoaded', function() {
			            console.log('üöÄ DigiLocker Interface Initialized - Candidate ID:', candidateId);
			            loadCandidateData();
			        });
			 
			        // Load candidate data from backend
			        async function loadCandidateData() {
			            try {
			                if (!candidateId) {
			                    throw new Error('Candidate ID not provided in URL');
			                }
			 
			                console.log('Loading candidate data for ID:', candidateId);
			                
			                const response = await fetch(`http://localhost:8068/api/candidate/${candidateId}/profile`);
			                
			                if (!response.ok) {
			                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
			                }
			 
			                const candidateData = await response.json();
			                
			                console.log('Received candidate data:', candidateData);
			                
			                // Update UI with candidate data
			                document.getElementById('userName').textContent = candidateData.fullName || 'Not available';
			                document.getElementById('userAadhar').textContent = candidateData.aadharNumber || 'Not available';
			                document.getElementById('userDOB').textContent = candidateData.dateOfBirth || 'Not available';
			                document.getElementById('userCandidateId').textContent = candidateData.candidateId || 'Not available';
			                
			                console.log('‚úÖ Candidate data loaded successfully');
			                
			                // Hide error message if it was shown
			                document.getElementById('errorMessage').style.display = 'none';
			                
			            } catch (error) {
			                console.error('‚ùå Failed to load candidate data:', error);
			                showError(`Failed to load candidate information: ${error.message}`);
			            }
			        }
			 
			        // Fetch documents from DigiLocker (Mock implementation)
			        async function fetchDocumentsFromDigiLocker() {
			            if (!candidateId) {
			                alert('‚ùå Candidate information not loaded properly.');
			                return;
			            }
			 
			            const fetchBtn = document.getElementById('fetchBtn');
			            const loadingSection = document.getElementById('loadingSection');
			            const progressFill = document.getElementById('progressFill');
			            const loadingStatus = document.getElementById('loadingStatus');
			 
			            // UI Updates
			            fetchBtn.disabled = true;
			            fetchBtn.textContent = 'Connecting...';
			            loadingSection.style.display = 'block';
			            
			            try {
			                // Simulate DigiLocker connection process
			                updateProgress(10, 'Connecting to DigiLocker...');
			                await new Promise(resolve => setTimeout(resolve, 1000));
			 
			                updateProgress(30, 'Authenticating...');
			                await new Promise(resolve => setTimeout(resolve, 1000));
			 
			                updateProgress(60, 'Fetching documents...');
			                await new Promise(resolve => setTimeout(resolve, 1500));
			 
			                // Mock document data
			                fetchedDocuments = {
			                    '10th_certificate': {
			                        name: '10th Class Marksheet',
			                        status: 'Available',
			                        issueDate: '2020-05-15',
			                        url: 'https://digilocker.gov.in/documents/10th_marksheet.pdf'
			                    },
			                    '12th_certificate': {
			                        name: '12th Class Marksheet',
			                        status: 'Available',
			                        issueDate: '2022-05-20',
			                        url: 'https://digilocker.gov.in/documents/12th_marksheet.pdf'
			                    },
			                    'degree_certificate': {
			                        name: 'Degree Certificate',
			                        status: 'Available',
			                        issueDate: '2024-06-10',
			                        url: 'https://digilocker.gov.in/documents/degree_certificate.pdf'
			                    },
			                    'btech_certificate': {
			                        name: 'B.Tech Degree',
			                        status: 'Available',
			                        issueDate: '2024-06-10',
			                        url: 'https://digilocker.gov.in/documents/btech_degree.pdf'
			                    }
			                };
			 
			                updateProgress(100, 'Documents fetched successfully!');
			 
			                // Show success message
			                setTimeout(() => {
			                    loadingSection.style.display = 'none';
			                    document.getElementById('successMessage').style.display = 'block';
			                    document.getElementById('submitBtn').style.display = 'block';
			                    fetchBtn.textContent = '‚úÖ Documents Fetched';
			                }, 1000);
			 
			            } catch (error) {
			                console.error('‚ùå DigiLocker fetch failed:', error);
			                loadingSection.style.display = 'none';
			                fetchBtn.disabled = false;
			                fetchBtn.textContent = 'üì• Fetch from DigiLocker';
			                showError(`Failed to fetch documents: ${error.message}`);
			            }
			        }
			 
			        // Update progress bar
			        function updateProgress(percent, status) {
			            const progressFill = document.getElementById('progressFill');
			            const loadingStatus = document.getElementById('loadingStatus');
			            
			            progressFill.style.width = percent + '%';
			            loadingStatus.textContent = status;
			        }
			 
			        // Select document
			        function selectDocument(element, docType) {
			            const index = selectedDocuments.indexOf(docType);
			            
			            if (index === -1) {
			                selectedDocuments.push(docType);
			                element.classList.add('selected');
			            } else {
			                selectedDocuments.splice(index, 1);
			                element.classList.remove('selected');
			            }
			            
			            console.log('Selected documents:', selectedDocuments);
			        }
			 
			        // Submit to application
					// Submit to application - FIXED VERSION
					// Submit to application - FIXED VERSION
					async function submitToApplication() {
					    const submitBtn = document.getElementById('submitBtn');
					    const originalText = submitBtn.textContent;
			 
					    try {
					        submitBtn.disabled = true;
					        submitBtn.textContent = 'Submitting...';
			 
					        console.log('Submitting documents for candidate:', candidateId);
			 
					        // Prepare the request data - MAKE SURE candidateId IS INCLUDED
					        const requestData = {
					            candidateId: parseInt(candidateId), // THIS IS CRITICAL
					            tenthCertificate: 'https://digilocker.gov.in/documents/10th_marksheet.pdf',
					            intermediateCertificate: 'https://digilocker.gov.in/documents/12th_marksheet.pdf',
					            degreeCertificate: 'https://digilocker.gov.in/documents/degree_certificate.pdf',
					            btechCertificate: 'https://digilocker.gov.in/documents/btech_degree.pdf',
					            diplomaCertificate: 'https://digilocker.gov.in/documents/diploma_certificate.pdf',
					            postGraduationCeritifcate: 'https://digilocker.gov.in/documents/pg_certificate.pdf'
					        };
			 
					        console.log('Sending data to callback:', requestData);
			 
					        // Call the callback endpoint
					        const response = await fetch('http://localhost:8068/api/candidate/digilocker/callback', {
					            method: 'POST',
					            headers: {
					                'Content-Type': 'application/json',
					                'Accept': 'application/json'
					            },
					            body: JSON.stringify(requestData)
					        });
			 
					        console.log('Response status:', response.status);
					        
					        if (!response.ok) {
					            let errorMessage = 'Network response was not ok';
					            try {
					                const errorData = await response.json();
					                errorMessage = errorData.message || errorData.error || JSON.stringify(errorData);
					            } catch (e) {
					                errorMessage = await response.text();
					            }
					            throw new Error(errorMessage);
					        }
			 
					        const result = await response.json();
					        console.log('Success response:', result);
			 
					        // Show success message
					        alert(`‚úÖ ${result.message}\nOTRAS ID: ${result.otrasId}`);
					        
					        // Close window after success
					        setTimeout(() => {
					            window.close();
					        }, 3000);
			 
					    } catch (error) {
					        console.error('‚ùå Submission failed:', error);
					        alert(`‚ùå Submission failed: ${error.message}\n\nPlease try again or contact support.`);
					        submitBtn.disabled = false;
					        submitBtn.textContent = originalText;
					    }
					}
			 
			        // Show error message
			        function showError(message) {
			            document.getElementById('errorText').textContent = message;
			            document.getElementById('errorMessage').style.display = 'block';
			        }
			 
			        // Close window
			        function closeWindow() {
			            if (confirm('Are you sure you want to close? Any unsaved progress will be lost.')) {
			                window.close();
			            }
			        }
			    </script>
			</body>
			</html>
			 